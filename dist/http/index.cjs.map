{"version":3,"sources":["../../src/config/build-info.ts","../../src/tracing/context.ts","../../src/tracing/middleware.ts","../../src/http/client.ts"],"names":["AsyncLocalStorage"],"mappings":"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","file":"index.cjs","sourcesContent":["/**\n * 构建信息模块\n *\n * 从环境变量读取 Docker 构建时注入的版本信息\n */\n\nexport interface BuildInfo {\n  /** Git commit hash */\n  gitCommit: string;\n  /** Git commit 短 hash */\n  shortCommit: string;\n  /** Git 分支名 */\n  gitBranch: string;\n  /** 构建日期 */\n  buildDate: string;\n  /** 应用版本 */\n  version: string;\n  /** 运行环境 */\n  environment: string;\n  /** 部署 ID（蓝绿部署） */\n  deploymentId: string;\n}\n\n/**\n * 获取构建信息\n */\nexport function getBuildInfo(): BuildInfo {\n  const gitCommit = process.env.GIT_COMMIT || \"unknown\";\n\n  return {\n    gitCommit,\n    shortCommit: gitCommit.substring(0, 7),\n    gitBranch: process.env.GIT_BRANCH || \"unknown\",\n    buildDate: process.env.BUILD_DATE || new Date().toISOString(),\n    version: process.env.APP_VERSION || \"0.0.0\",\n    environment: process.env.NODE_ENV || \"development\",\n    deploymentId: process.env.DEPLOYMENT_ID || \"\",\n  };\n}\n\n// 单例缓存\nlet cachedBuildInfo: BuildInfo | null = null;\n\n/**\n * 获取缓存的构建信息\n */\nexport function getCachedBuildInfo(): BuildInfo {\n  if (!cachedBuildInfo) {\n    cachedBuildInfo = getBuildInfo();\n  }\n  return cachedBuildInfo;\n}\n","/**\n * 追踪上下文模块\n *\n * 使用 AsyncLocalStorage 实现异步上下文隔离\n */\n\nimport { AsyncLocalStorage } from \"node:async_hooks\";\n\nexport interface TraceContext {\n  traceId?: string;\n  requestId?: string;\n  parentSpanId?: string;\n}\n\n// AsyncLocalStorage 实例\nconst asyncLocalStorage = new AsyncLocalStorage<TraceContext>();\n\n/**\n * 获取当前追踪上下文\n */\nexport function getTraceContext(): TraceContext {\n  return asyncLocalStorage.getStore() || {};\n}\n\n/**\n * 获取当前 trace_id\n */\nexport function getTraceId(): string | undefined {\n  return getTraceContext().traceId;\n}\n\n/**\n * 获取当前 request_id\n */\nexport function getRequestId(): string | undefined {\n  return getTraceContext().requestId;\n}\n\n/**\n * 获取当前 parent_span_id\n */\nexport function getParentSpanId(): string | undefined {\n  return getTraceContext().parentSpanId;\n}\n\n/**\n * 在追踪上下文中运行函数\n *\n * @example\n * await runWithTraceContext(\n *   { traceId: 'trace-123', requestId: 'req-456' },\n *   async () => {\n *     // 这里可以访问上下文\n *     const traceId = getTraceId();\n *   }\n * );\n */\nexport function runWithTraceContext<T>(\n  context: TraceContext,\n  fn: () => T\n): T {\n  return asyncLocalStorage.run(context, fn);\n}\n\n/**\n * 从请求 header 解析追踪上下文\n */\nexport function parseTraceContextFromHeaders(headers: Headers): TraceContext {\n  return {\n    traceId: headers.get(\"X-Trace-ID\") || undefined,\n    parentSpanId: headers.get(\"X-Parent-Span-ID\") || undefined,\n    // requestId 每个服务自己生成，不从 header 读取\n  };\n}\n","/**\n * Next.js 追踪中间件模块\n */\n\nimport { getCachedBuildInfo } from \"../config/build-info\";\nimport {\n  getTraceContext,\n  parseTraceContextFromHeaders,\n  runWithTraceContext,\n  type TraceContext,\n} from \"./context\";\nimport { generateRequestId, generateTraceId } from \"./ids\";\n\n// Header 常量\nexport const TRACE_ID_HEADER = \"X-Trace-ID\";\nexport const REQUEST_ID_HEADER = \"X-Request-ID\";\nexport const PARENT_SPAN_ID_HEADER = \"X-Parent-Span-ID\";\nexport const DEPLOYMENT_ID_HEADER = \"X-Deployment-ID\";\nexport const RESPONSE_TIME_HEADER = \"X-Response-Time\";\nexport const SERVED_BY_HEADER = \"X-Served-By\";\n\nexport interface TracingOptions {\n  serviceName: string;\n  serviceShort?: string;\n}\n\n/**\n * 为响应添加追踪 header\n */\nexport function addTracingHeaders(\n  response: Response,\n  context: TraceContext,\n  options: {\n    serviceName: string;\n    durationMs: number;\n  }\n): Response {\n  const buildInfo = getCachedBuildInfo();\n\n  // 克隆响应以添加 header\n  const headers = new Headers(response.headers);\n\n  if (context.traceId) {\n    headers.set(TRACE_ID_HEADER, context.traceId);\n  }\n\n  if (context.requestId) {\n    headers.set(REQUEST_ID_HEADER, context.requestId);\n  }\n\n  headers.set(RESPONSE_TIME_HEADER, `${options.durationMs.toFixed(2)}ms`);\n  headers.set(\n    SERVED_BY_HEADER,\n    `${options.serviceName}-${buildInfo.shortCommit}`\n  );\n\n  if (buildInfo.deploymentId) {\n    headers.set(DEPLOYMENT_ID_HEADER, buildInfo.deploymentId);\n  }\n\n  return new Response(response.body, {\n    status: response.status,\n    statusText: response.statusText,\n    headers,\n  });\n}\n\n/**\n * 包装 API route handler 添加追踪支持\n *\n * @example\n * // app/api/users/route.ts\n * import { withTracing } from '@optima/core/tracing';\n *\n * async function handler(request: Request) {\n *   return Response.json({ users: [] });\n * }\n *\n * export const GET = withTracing(handler, {\n *   serviceName: 'agentic-chat',\n *   serviceShort: 'chat',\n * });\n */\nexport function withTracing<T extends (request: Request, ...args: unknown[]) => Promise<Response>>(\n  handler: T,\n  options: TracingOptions\n): T {\n  const { serviceName, serviceShort = serviceName.substring(0, 4) } = options;\n\n  return (async (request: Request, ...args: unknown[]) => {\n    const startTime = Date.now();\n\n    // 从 header 解析上游追踪信息\n    const upstreamContext = parseTraceContextFromHeaders(request.headers);\n\n    // 创建当前请求的上下文\n    const context: TraceContext = {\n      traceId: upstreamContext.traceId || generateTraceId(serviceShort),\n      requestId: generateRequestId(serviceShort),\n      parentSpanId: upstreamContext.parentSpanId,\n    };\n\n    // 在追踪上下文中运行 handler\n    const response = await runWithTraceContext(context, () =>\n      handler(request, ...args)\n    );\n\n    const durationMs = Date.now() - startTime;\n\n    // 添加追踪 header 到响应\n    return addTracingHeaders(response, context, {\n      serviceName,\n      durationMs,\n    });\n  }) as T;\n}\n\n/**\n * 获取需要传递给下游服务的追踪 header\n */\nexport function getTraceHeaders(): Record<string, string> {\n  const context = getTraceContext();\n  const buildInfo = getCachedBuildInfo();\n  const headers: Record<string, string> = {};\n\n  if (context.traceId) {\n    headers[TRACE_ID_HEADER] = context.traceId;\n  }\n\n  if (context.requestId) {\n    headers[PARENT_SPAN_ID_HEADER] = context.requestId;\n  }\n\n  if (buildInfo.deploymentId) {\n    headers[DEPLOYMENT_ID_HEADER] = buildInfo.deploymentId;\n  }\n\n  return headers;\n}\n","/**\n * 带追踪的 HTTP 客户端模块\n */\n\nimport { getTraceHeaders } from \"../tracing/middleware\";\n\nexport interface TracedFetchOptions extends RequestInit {\n  /** 是否自动注入追踪 header（默认 true） */\n  injectTracing?: boolean;\n}\n\n/**\n * 带追踪的 fetch 函数\n *\n * 自动注入追踪 header 到请求中\n *\n * @example\n * import { tracedFetch } from '@optima/core/http';\n *\n * // 在 API route 中使用（已有追踪上下文）\n * const response = await tracedFetch('http://other-service/api/data');\n *\n * // 禁用追踪注入\n * const response = await tracedFetch('http://api.example.com', {\n *   injectTracing: false,\n * });\n */\nexport async function tracedFetch(\n  url: string | URL,\n  options: TracedFetchOptions = {}\n): Promise<Response> {\n  const { injectTracing = true, headers: userHeaders, ...restOptions } = options;\n\n  const headers = new Headers(userHeaders);\n\n  // 注入追踪 header\n  if (injectTracing) {\n    const traceHeaders = getTraceHeaders();\n    for (const [key, value] of Object.entries(traceHeaders)) {\n      if (!headers.has(key)) {\n        headers.set(key, value);\n      }\n    }\n  }\n\n  return fetch(url, {\n    ...restOptions,\n    headers,\n  });\n}\n\n/**\n * 创建带基础 URL 的 traced fetch 客户端\n *\n * @example\n * const api = createTracedClient('http://user-auth:8000');\n *\n * const response = await api.get('/users/123');\n * const data = await api.post('/users', { name: 'John' });\n */\nexport function createTracedClient(baseUrl: string) {\n  async function request(\n    method: string,\n    path: string,\n    options: TracedFetchOptions = {}\n  ): Promise<Response> {\n    const url = new URL(path, baseUrl);\n    return tracedFetch(url, {\n      method,\n      ...options,\n    });\n  }\n\n  return {\n    /**\n     * 发送 GET 请求\n     */\n    get: (path: string, options?: TracedFetchOptions) =>\n      request(\"GET\", path, options),\n\n    /**\n     * 发送 POST 请求\n     */\n    post: (\n      path: string,\n      body?: unknown,\n      options?: TracedFetchOptions\n    ) =>\n      request(\"POST\", path, {\n        ...options,\n        headers: {\n          \"Content-Type\": \"application/json\",\n          ...options?.headers,\n        },\n        body: body ? JSON.stringify(body) : undefined,\n      }),\n\n    /**\n     * 发送 PUT 请求\n     */\n    put: (\n      path: string,\n      body?: unknown,\n      options?: TracedFetchOptions\n    ) =>\n      request(\"PUT\", path, {\n        ...options,\n        headers: {\n          \"Content-Type\": \"application/json\",\n          ...options?.headers,\n        },\n        body: body ? JSON.stringify(body) : undefined,\n      }),\n\n    /**\n     * 发送 PATCH 请求\n     */\n    patch: (\n      path: string,\n      body?: unknown,\n      options?: TracedFetchOptions\n    ) =>\n      request(\"PATCH\", path, {\n        ...options,\n        headers: {\n          \"Content-Type\": \"application/json\",\n          ...options?.headers,\n        },\n        body: body ? JSON.stringify(body) : undefined,\n      }),\n\n    /**\n     * 发送 DELETE 请求\n     */\n    delete: (path: string, options?: TracedFetchOptions) =>\n      request(\"DELETE\", path, options),\n\n    /**\n     * 发送自定义请求\n     */\n    request,\n  };\n}\n"]}
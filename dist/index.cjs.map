{"version":3,"sources":["../src/config/build-info.ts","../src/diagnostics/health.ts","../src/diagnostics/endpoints.ts","../src/tracing/context.ts","../src/logging/logger.ts","../src/tracing/ids.ts","../src/tracing/middleware.ts","../src/http/client.ts"],"names":["startTime","AsyncLocalStorage"],"mappings":"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","file":"index.cjs","sourcesContent":["/**\n * 构建信息模块\n *\n * 从环境变量读取 Docker 构建时注入的版本信息\n */\n\nexport interface BuildInfo {\n  /** Git commit hash */\n  gitCommit: string;\n  /** Git commit 短 hash */\n  shortCommit: string;\n  /** Git 分支名 */\n  gitBranch: string;\n  /** 构建日期 */\n  buildDate: string;\n  /** 应用版本 */\n  version: string;\n  /** 运行环境 */\n  environment: string;\n  /** 部署 ID（蓝绿部署） */\n  deploymentId: string;\n}\n\n/**\n * 获取构建信息\n */\nexport function getBuildInfo(): BuildInfo {\n  const gitCommit = process.env.GIT_COMMIT || \"unknown\";\n\n  return {\n    gitCommit,\n    shortCommit: gitCommit.substring(0, 7),\n    gitBranch: process.env.GIT_BRANCH || \"unknown\",\n    buildDate: process.env.BUILD_DATE || new Date().toISOString(),\n    version: process.env.APP_VERSION || \"0.0.0\",\n    environment: process.env.NODE_ENV || \"development\",\n    deploymentId: process.env.DEPLOYMENT_ID || \"\",\n  };\n}\n\n// 单例缓存\nlet cachedBuildInfo: BuildInfo | null = null;\n\n/**\n * 获取缓存的构建信息\n */\nexport function getCachedBuildInfo(): BuildInfo {\n  if (!cachedBuildInfo) {\n    cachedBuildInfo = getBuildInfo();\n  }\n  return cachedBuildInfo;\n}\n","/**\n * 健康检查模块\n */\n\nimport { getCachedBuildInfo } from \"../config/build-info\";\n\nexport interface HealthCheckResult {\n  status: \"healthy\" | \"unhealthy\";\n  latencyMs?: number;\n  error?: string;\n}\n\nexport type HealthCheckFn = () => Promise<HealthCheckResult> | HealthCheckResult;\n\nexport interface HealthChecks {\n  [name: string]: HealthCheckFn;\n}\n\nexport interface HealthResponse {\n  status: \"healthy\" | \"unhealthy\";\n  service: string;\n  version: string;\n  gitCommit: string;\n  gitBranch: string;\n  environment: string;\n  uptimeSeconds: number;\n  timestamp: string;\n  checks: Record<string, HealthCheckResult>;\n}\n\n// 启动时间\nconst startTime = Date.now();\n\n/**\n * 运行健康检查\n */\nexport async function runHealthChecks(\n  serviceName: string,\n  checks: HealthChecks = {}\n): Promise<HealthResponse> {\n  const buildInfo = getCachedBuildInfo();\n  const checkResults: Record<string, HealthCheckResult> = {};\n  let overallHealthy = true;\n\n  // 运行所有检查\n  for (const [name, checkFn] of Object.entries(checks)) {\n    const start = Date.now();\n    try {\n      const result = await checkFn();\n      checkResults[name] = {\n        ...result,\n        latencyMs: Date.now() - start,\n      };\n      if (result.status === \"unhealthy\") {\n        overallHealthy = false;\n      }\n    } catch (error) {\n      overallHealthy = false;\n      checkResults[name] = {\n        status: \"unhealthy\",\n        latencyMs: Date.now() - start,\n        error: error instanceof Error ? error.message : String(error),\n      };\n    }\n  }\n\n  return {\n    status: overallHealthy ? \"healthy\" : \"unhealthy\",\n    service: serviceName,\n    version: buildInfo.version,\n    gitCommit: buildInfo.shortCommit,\n    gitBranch: buildInfo.gitBranch,\n    environment: buildInfo.environment,\n    uptimeSeconds: Math.floor((Date.now() - startTime) / 1000),\n    timestamp: new Date().toISOString(),\n    checks: checkResults,\n  };\n}\n\n/**\n * 创建 Next.js API Route 健康检查处理器\n *\n * @example\n * // app/api/health/route.ts\n * import { createHealthHandler } from '@optima/core/diagnostics';\n *\n * export const GET = createHealthHandler({\n *   serviceName: 'agentic-chat',\n *   checks: {\n *     database: async () => {\n *       // 检查数据库\n *       return { status: 'healthy' };\n *     },\n *   },\n * });\n */\nexport function createHealthHandler(options: {\n  serviceName: string;\n  checks?: HealthChecks;\n}): () => Promise<Response> {\n  return async function GET(): Promise<Response> {\n    const result = await runHealthChecks(\n      options.serviceName,\n      options.checks || {}\n    );\n\n    return Response.json(result, {\n      status: result.status === \"healthy\" ? 200 : 503,\n      headers: {\n        \"Cache-Control\": \"no-store\",\n      },\n    });\n  };\n}\n","/**\n * 调试端点模块\n */\n\nimport { getCachedBuildInfo } from \"../config/build-info\";\n\n// 启动时间\nconst startTime = Date.now();\n\nexport interface DebugInfoResponse {\n  build: {\n    gitCommit: string;\n    gitBranch: string;\n    buildDate: string;\n    version: string;\n  };\n  runtime: {\n    nodeVersion: string;\n    environment: string;\n    debugMode: boolean;\n    logLevel: string;\n  };\n  startupTime: string;\n  uptimeSeconds: number;\n}\n\nexport interface DebugConfigResponse {\n  config: Record<string, string>;\n  infisicalEnabled: boolean;\n  configSource: string;\n}\n\n/**\n * 获取调试信息\n */\nexport function getDebugInfo(): DebugInfoResponse {\n  const buildInfo = getCachedBuildInfo();\n\n  return {\n    build: {\n      gitCommit: buildInfo.gitCommit,\n      gitBranch: buildInfo.gitBranch,\n      buildDate: buildInfo.buildDate,\n      version: buildInfo.version,\n    },\n    runtime: {\n      nodeVersion: process.version,\n      environment: buildInfo.environment,\n      debugMode: process.env.DEBUG === \"true\",\n      logLevel: process.env.LOG_LEVEL || \"info\",\n    },\n    startupTime: new Date(startTime).toISOString(),\n    uptimeSeconds: Math.floor((Date.now() - startTime) / 1000),\n  };\n}\n\n/**\n * 敏感环境变量模式\n */\nconst SENSITIVE_PATTERNS = [\n  /key/i,\n  /secret/i,\n  /password/i,\n  /token/i,\n  /credential/i,\n  /private/i,\n  /auth/i,\n];\n\n/**\n * 脱敏环境变量值\n */\nfunction maskValue(key: string, value: string): string {\n  const isSensitive = SENSITIVE_PATTERNS.some((pattern) => pattern.test(key));\n\n  if (isSensitive) {\n    return `** (${value.length} chars)`;\n  }\n\n  // URL 中的密码脱敏\n  if (value.includes(\"://\") && value.includes(\"@\")) {\n    return value.replace(/:([^@/]+)@/, \":***@\");\n  }\n\n  return value;\n}\n\n/**\n * 获取脱敏后的配置\n */\nexport function getDebugConfig(\n  allowedPrefixes: string[] = [\"DATABASE\", \"REDIS\", \"OAUTH\", \"CORS\", \"API\"]\n): DebugConfigResponse {\n  const config: Record<string, string> = {};\n\n  for (const [key, value] of Object.entries(process.env)) {\n    if (!value) continue;\n\n    // 只返回指定前缀的变量\n    const matchesPrefix = allowedPrefixes.some((prefix) =>\n      key.startsWith(prefix)\n    );\n\n    if (matchesPrefix) {\n      config[key] = maskValue(key, value);\n    }\n  }\n\n  return {\n    config,\n    infisicalEnabled: !!process.env.INFISICAL_CLIENT_ID,\n    configSource: process.env.INFISICAL_CLIENT_ID ? \"infisical\" : \"env\",\n  };\n}\n\n/**\n * 验证 Debug Key\n */\nexport function validateDebugKey(request: Request): boolean {\n  const debugKey = process.env.DEBUG_KEY;\n  if (!debugKey) {\n    return false;\n  }\n\n  const providedKey = request.headers.get(\"X-Debug-Key\");\n  return providedKey === debugKey;\n}\n\n/**\n * 创建 /debug/info 端点处理器\n *\n * @example\n * // app/api/debug/info/route.ts\n * import { createDebugInfoHandler } from '@optima/core/diagnostics';\n * export const GET = createDebugInfoHandler();\n */\nexport function createDebugInfoHandler(options?: { requireKey?: boolean }): (\n  request: Request\n) => Promise<Response> {\n  return async function GET(request: Request): Promise<Response> {\n    if (options?.requireKey && !validateDebugKey(request)) {\n      return Response.json({ error: \"Unauthorized\" }, { status: 401 });\n    }\n\n    return Response.json(getDebugInfo(), {\n      headers: { \"Cache-Control\": \"no-store\" },\n    });\n  };\n}\n\n/**\n * 创建 /debug/config 端点处理器\n *\n * @example\n * // app/api/debug/config/route.ts\n * import { createDebugConfigHandler } from '@optima/core/diagnostics';\n * export const GET = createDebugConfigHandler();\n */\nexport function createDebugConfigHandler(options?: {\n  allowedPrefixes?: string[];\n}): (request: Request) => Promise<Response> {\n  return async function GET(request: Request): Promise<Response> {\n    if (!validateDebugKey(request)) {\n      return Response.json(\n        { error: \"Unauthorized - X-Debug-Key required\" },\n        { status: 401 }\n      );\n    }\n\n    return Response.json(getDebugConfig(options?.allowedPrefixes), {\n      headers: { \"Cache-Control\": \"no-store\" },\n    });\n  };\n}\n","/**\n * 追踪上下文模块\n *\n * 使用 AsyncLocalStorage 实现异步上下文隔离\n */\n\nimport { AsyncLocalStorage } from \"node:async_hooks\";\n\nexport interface TraceContext {\n  traceId?: string;\n  requestId?: string;\n  parentSpanId?: string;\n}\n\n// AsyncLocalStorage 实例\nconst asyncLocalStorage = new AsyncLocalStorage<TraceContext>();\n\n/**\n * 获取当前追踪上下文\n */\nexport function getTraceContext(): TraceContext {\n  return asyncLocalStorage.getStore() || {};\n}\n\n/**\n * 获取当前 trace_id\n */\nexport function getTraceId(): string | undefined {\n  return getTraceContext().traceId;\n}\n\n/**\n * 获取当前 request_id\n */\nexport function getRequestId(): string | undefined {\n  return getTraceContext().requestId;\n}\n\n/**\n * 获取当前 parent_span_id\n */\nexport function getParentSpanId(): string | undefined {\n  return getTraceContext().parentSpanId;\n}\n\n/**\n * 在追踪上下文中运行函数\n *\n * @example\n * await runWithTraceContext(\n *   { traceId: 'trace-123', requestId: 'req-456' },\n *   async () => {\n *     // 这里可以访问上下文\n *     const traceId = getTraceId();\n *   }\n * );\n */\nexport function runWithTraceContext<T>(\n  context: TraceContext,\n  fn: () => T\n): T {\n  return asyncLocalStorage.run(context, fn);\n}\n\n/**\n * 从请求 header 解析追踪上下文\n */\nexport function parseTraceContextFromHeaders(headers: Headers): TraceContext {\n  return {\n    traceId: headers.get(\"X-Trace-ID\") || undefined,\n    parentSpanId: headers.get(\"X-Parent-Span-ID\") || undefined,\n    // requestId 每个服务自己生成，不从 header 读取\n  };\n}\n","/**\n * 结构化日志模块\n */\n\nimport { getCachedBuildInfo } from \"../config/build-info\";\nimport { getTraceContext } from \"../tracing/context\";\n\nexport type LogLevel = \"debug\" | \"info\" | \"warn\" | \"error\";\n\nexport interface LogEntry {\n  timestamp: string;\n  level: LogLevel;\n  service: string;\n  version: string;\n  gitCommit: string;\n  environment: string;\n  deploymentId?: string;\n  traceId?: string;\n  requestId?: string;\n  parentSpanId?: string;\n  message: string;\n  extra?: Record<string, unknown>;\n  exception?: {\n    type: string;\n    message: string;\n    stack?: string;\n  };\n}\n\nexport interface LoggerOptions {\n  serviceName: string;\n  format?: \"json\" | \"text\";\n  level?: LogLevel;\n}\n\nconst LOG_LEVELS: Record<LogLevel, number> = {\n  debug: 0,\n  info: 1,\n  warn: 2,\n  error: 3,\n};\n\n/**\n * 创建结构化日志器\n */\nexport function createLogger(options: LoggerOptions) {\n  const {\n    serviceName,\n    format = process.env.LOG_FORMAT === \"text\" ? \"text\" : \"json\",\n    level = (process.env.LOG_LEVEL as LogLevel) || \"info\",\n  } = options;\n\n  const minLevel = LOG_LEVELS[level];\n\n  function shouldLog(logLevel: LogLevel): boolean {\n    return LOG_LEVELS[logLevel] >= minLevel;\n  }\n\n  function formatEntry(entry: LogEntry): string {\n    if (format === \"text\") {\n      const parts = [\n        entry.timestamp,\n        `[${entry.level.toUpperCase()}]`,\n        entry.service,\n        \"-\",\n        entry.message,\n      ];\n\n      if (entry.traceId) {\n        parts.push(`| trace_id=${entry.traceId}`);\n      }\n\n      if (entry.exception) {\n        parts.push(`\\n${entry.exception.stack || entry.exception.message}`);\n      }\n\n      return parts.join(\" \");\n    }\n\n    return JSON.stringify(entry);\n  }\n\n  function log(\n    logLevel: LogLevel,\n    message: string,\n    extra?: Record<string, unknown>,\n    error?: Error\n  ): void {\n    if (!shouldLog(logLevel)) {\n      return;\n    }\n\n    const buildInfo = getCachedBuildInfo();\n    const traceContext = getTraceContext();\n\n    const entry: LogEntry = {\n      timestamp: new Date().toISOString(),\n      level: logLevel,\n      service: serviceName,\n      version: buildInfo.version,\n      gitCommit: buildInfo.shortCommit,\n      environment: buildInfo.environment,\n      message,\n    };\n\n    if (buildInfo.deploymentId) {\n      entry.deploymentId = buildInfo.deploymentId;\n    }\n\n    if (traceContext.traceId) {\n      entry.traceId = traceContext.traceId;\n    }\n\n    if (traceContext.requestId) {\n      entry.requestId = traceContext.requestId;\n    }\n\n    if (traceContext.parentSpanId) {\n      entry.parentSpanId = traceContext.parentSpanId;\n    }\n\n    if (extra && Object.keys(extra).length > 0) {\n      entry.extra = extra;\n    }\n\n    if (error) {\n      entry.exception = {\n        type: error.name,\n        message: error.message,\n        stack: error.stack,\n      };\n    }\n\n    const output = formatEntry(entry);\n\n    switch (logLevel) {\n      case \"debug\":\n        console.debug(output);\n        break;\n      case \"info\":\n        console.info(output);\n        break;\n      case \"warn\":\n        console.warn(output);\n        break;\n      case \"error\":\n        console.error(output);\n        break;\n    }\n  }\n\n  return {\n    debug: (message: string, extra?: Record<string, unknown>) =>\n      log(\"debug\", message, extra),\n\n    info: (message: string, extra?: Record<string, unknown>) =>\n      log(\"info\", message, extra),\n\n    warn: (message: string, extra?: Record<string, unknown>) =>\n      log(\"warn\", message, extra),\n\n    error: (message: string, extra?: Record<string, unknown>, error?: Error) =>\n      log(\"error\", message, extra, error),\n\n    exception: (message: string, error: Error, extra?: Record<string, unknown>) =>\n      log(\"error\", message, extra, error),\n  };\n}\n\n// 默认 logger（需要先配置）\nlet defaultLogger: ReturnType<typeof createLogger> | null = null;\n\n/**\n * 配置默认 logger\n */\nexport function configureLogger(options: LoggerOptions): void {\n  defaultLogger = createLogger(options);\n}\n\n/**\n * 获取默认 logger\n */\nexport function getLogger(): ReturnType<typeof createLogger> {\n  if (!defaultLogger) {\n    // 返回一个空操作的 logger\n    return {\n      debug: () => {},\n      info: () => {},\n      warn: () => {},\n      error: () => {},\n      exception: () => {},\n    };\n  }\n  return defaultLogger;\n}\n","/**\n * 追踪 ID 生成模块\n */\n\n/**\n * 生成随机 hex 字符串\n */\nfunction randomHex(length: number): string {\n  const bytes = new Uint8Array(Math.ceil(length / 2));\n  crypto.getRandomValues(bytes);\n  return Array.from(bytes)\n    .map((b) => b.toString(16).padStart(2, \"0\"))\n    .join(\"\")\n    .substring(0, length);\n}\n\n/**\n * 生成 trace_id\n *\n * 格式: {timestamp_hex}-{random_hex}-{service_short}\n * 示例: 67890abc-f1e2d3c4b5a6-auth\n *\n * @param serviceShort - 服务简称（默认 \"svc\"）\n */\nexport function generateTraceId(serviceShort: string = \"svc\"): string {\n  const timestamp = Math.floor(Date.now() / 1000).toString(16);\n  const random = randomHex(12);\n  return `${timestamp}-${random}-${serviceShort}`;\n}\n\n/**\n * 生成 request_id\n *\n * 格式: {prefix}_{random_hex}\n * 示例: auth_f1e2d3c4b5a6\n *\n * @param prefix - 前缀（默认 \"req\"）\n */\nexport function generateRequestId(prefix: string = \"req\"): string {\n  return `${prefix}_${randomHex(12)}`;\n}\n\n/**\n * 解析 trace_id\n */\nexport function parseTraceId(traceId: string): {\n  valid: boolean;\n  timestamp?: number;\n  random?: string;\n  serviceShort?: string;\n  raw?: string;\n} {\n  const parts = traceId.split(\"-\");\n\n  if (parts.length < 3) {\n    return { valid: false, raw: traceId };\n  }\n\n  const [timestampHex, random, ...serviceParts] = parts;\n  const timestamp = parseInt(timestampHex, 16);\n\n  if (isNaN(timestamp)) {\n    return { valid: false, raw: traceId };\n  }\n\n  return {\n    valid: true,\n    timestamp,\n    random,\n    serviceShort: serviceParts.join(\"-\"),\n  };\n}\n","/**\n * Next.js 追踪中间件模块\n */\n\nimport { getCachedBuildInfo } from \"../config/build-info\";\nimport {\n  getTraceContext,\n  parseTraceContextFromHeaders,\n  runWithTraceContext,\n  type TraceContext,\n} from \"./context\";\nimport { generateRequestId, generateTraceId } from \"./ids\";\n\n// Header 常量\nexport const TRACE_ID_HEADER = \"X-Trace-ID\";\nexport const REQUEST_ID_HEADER = \"X-Request-ID\";\nexport const PARENT_SPAN_ID_HEADER = \"X-Parent-Span-ID\";\nexport const DEPLOYMENT_ID_HEADER = \"X-Deployment-ID\";\nexport const RESPONSE_TIME_HEADER = \"X-Response-Time\";\nexport const SERVED_BY_HEADER = \"X-Served-By\";\n\nexport interface TracingOptions {\n  serviceName: string;\n  serviceShort?: string;\n}\n\n/**\n * 为响应添加追踪 header\n */\nexport function addTracingHeaders(\n  response: Response,\n  context: TraceContext,\n  options: {\n    serviceName: string;\n    durationMs: number;\n  }\n): Response {\n  const buildInfo = getCachedBuildInfo();\n\n  // 克隆响应以添加 header\n  const headers = new Headers(response.headers);\n\n  if (context.traceId) {\n    headers.set(TRACE_ID_HEADER, context.traceId);\n  }\n\n  if (context.requestId) {\n    headers.set(REQUEST_ID_HEADER, context.requestId);\n  }\n\n  headers.set(RESPONSE_TIME_HEADER, `${options.durationMs.toFixed(2)}ms`);\n  headers.set(\n    SERVED_BY_HEADER,\n    `${options.serviceName}-${buildInfo.shortCommit}`\n  );\n\n  if (buildInfo.deploymentId) {\n    headers.set(DEPLOYMENT_ID_HEADER, buildInfo.deploymentId);\n  }\n\n  return new Response(response.body, {\n    status: response.status,\n    statusText: response.statusText,\n    headers,\n  });\n}\n\n/**\n * 包装 API route handler 添加追踪支持\n *\n * @example\n * // app/api/users/route.ts\n * import { withTracing } from '@optima/core/tracing';\n *\n * async function handler(request: Request) {\n *   return Response.json({ users: [] });\n * }\n *\n * export const GET = withTracing(handler, {\n *   serviceName: 'agentic-chat',\n *   serviceShort: 'chat',\n * });\n */\nexport function withTracing<T extends (request: Request, ...args: unknown[]) => Promise<Response>>(\n  handler: T,\n  options: TracingOptions\n): T {\n  const { serviceName, serviceShort = serviceName.substring(0, 4) } = options;\n\n  return (async (request: Request, ...args: unknown[]) => {\n    const startTime = Date.now();\n\n    // 从 header 解析上游追踪信息\n    const upstreamContext = parseTraceContextFromHeaders(request.headers);\n\n    // 创建当前请求的上下文\n    const context: TraceContext = {\n      traceId: upstreamContext.traceId || generateTraceId(serviceShort),\n      requestId: generateRequestId(serviceShort),\n      parentSpanId: upstreamContext.parentSpanId,\n    };\n\n    // 在追踪上下文中运行 handler\n    const response = await runWithTraceContext(context, () =>\n      handler(request, ...args)\n    );\n\n    const durationMs = Date.now() - startTime;\n\n    // 添加追踪 header 到响应\n    return addTracingHeaders(response, context, {\n      serviceName,\n      durationMs,\n    });\n  }) as T;\n}\n\n/**\n * 获取需要传递给下游服务的追踪 header\n */\nexport function getTraceHeaders(): Record<string, string> {\n  const context = getTraceContext();\n  const buildInfo = getCachedBuildInfo();\n  const headers: Record<string, string> = {};\n\n  if (context.traceId) {\n    headers[TRACE_ID_HEADER] = context.traceId;\n  }\n\n  if (context.requestId) {\n    headers[PARENT_SPAN_ID_HEADER] = context.requestId;\n  }\n\n  if (buildInfo.deploymentId) {\n    headers[DEPLOYMENT_ID_HEADER] = buildInfo.deploymentId;\n  }\n\n  return headers;\n}\n","/**\n * 带追踪的 HTTP 客户端模块\n */\n\nimport { getTraceHeaders } from \"../tracing/middleware\";\n\nexport interface TracedFetchOptions extends RequestInit {\n  /** 是否自动注入追踪 header（默认 true） */\n  injectTracing?: boolean;\n}\n\n/**\n * 带追踪的 fetch 函数\n *\n * 自动注入追踪 header 到请求中\n *\n * @example\n * import { tracedFetch } from '@optima/core/http';\n *\n * // 在 API route 中使用（已有追踪上下文）\n * const response = await tracedFetch('http://other-service/api/data');\n *\n * // 禁用追踪注入\n * const response = await tracedFetch('http://api.example.com', {\n *   injectTracing: false,\n * });\n */\nexport async function tracedFetch(\n  url: string | URL,\n  options: TracedFetchOptions = {}\n): Promise<Response> {\n  const { injectTracing = true, headers: userHeaders, ...restOptions } = options;\n\n  const headers = new Headers(userHeaders);\n\n  // 注入追踪 header\n  if (injectTracing) {\n    const traceHeaders = getTraceHeaders();\n    for (const [key, value] of Object.entries(traceHeaders)) {\n      if (!headers.has(key)) {\n        headers.set(key, value);\n      }\n    }\n  }\n\n  return fetch(url, {\n    ...restOptions,\n    headers,\n  });\n}\n\n/**\n * 创建带基础 URL 的 traced fetch 客户端\n *\n * @example\n * const api = createTracedClient('http://user-auth:8000');\n *\n * const response = await api.get('/users/123');\n * const data = await api.post('/users', { name: 'John' });\n */\nexport function createTracedClient(baseUrl: string) {\n  async function request(\n    method: string,\n    path: string,\n    options: TracedFetchOptions = {}\n  ): Promise<Response> {\n    const url = new URL(path, baseUrl);\n    return tracedFetch(url, {\n      method,\n      ...options,\n    });\n  }\n\n  return {\n    /**\n     * 发送 GET 请求\n     */\n    get: (path: string, options?: TracedFetchOptions) =>\n      request(\"GET\", path, options),\n\n    /**\n     * 发送 POST 请求\n     */\n    post: (\n      path: string,\n      body?: unknown,\n      options?: TracedFetchOptions\n    ) =>\n      request(\"POST\", path, {\n        ...options,\n        headers: {\n          \"Content-Type\": \"application/json\",\n          ...options?.headers,\n        },\n        body: body ? JSON.stringify(body) : undefined,\n      }),\n\n    /**\n     * 发送 PUT 请求\n     */\n    put: (\n      path: string,\n      body?: unknown,\n      options?: TracedFetchOptions\n    ) =>\n      request(\"PUT\", path, {\n        ...options,\n        headers: {\n          \"Content-Type\": \"application/json\",\n          ...options?.headers,\n        },\n        body: body ? JSON.stringify(body) : undefined,\n      }),\n\n    /**\n     * 发送 PATCH 请求\n     */\n    patch: (\n      path: string,\n      body?: unknown,\n      options?: TracedFetchOptions\n    ) =>\n      request(\"PATCH\", path, {\n        ...options,\n        headers: {\n          \"Content-Type\": \"application/json\",\n          ...options?.headers,\n        },\n        body: body ? JSON.stringify(body) : undefined,\n      }),\n\n    /**\n     * 发送 DELETE 请求\n     */\n    delete: (path: string, options?: TracedFetchOptions) =>\n      request(\"DELETE\", path, options),\n\n    /**\n     * 发送自定义请求\n     */\n    request,\n  };\n}\n"]}
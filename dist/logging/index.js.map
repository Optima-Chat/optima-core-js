{"version":3,"sources":["../../src/config/build-info.ts","../../src/tracing/context.ts","../../src/logging/logger.ts"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["/**\n * 构建信息模块\n *\n * 从环境变量读取 Docker 构建时注入的版本信息\n */\n\nexport interface BuildInfo {\n  /** Git commit hash */\n  gitCommit: string;\n  /** Git commit 短 hash */\n  shortCommit: string;\n  /** Git 分支名 */\n  gitBranch: string;\n  /** 构建日期 */\n  buildDate: string;\n  /** 应用版本 */\n  version: string;\n  /** 运行环境 */\n  environment: string;\n  /** 部署 ID（蓝绿部署） */\n  deploymentId: string;\n}\n\n/**\n * 获取构建信息\n */\nexport function getBuildInfo(): BuildInfo {\n  const gitCommit = process.env.GIT_COMMIT || \"unknown\";\n\n  return {\n    gitCommit,\n    shortCommit: gitCommit.substring(0, 7),\n    gitBranch: process.env.GIT_BRANCH || \"unknown\",\n    buildDate: process.env.BUILD_DATE || new Date().toISOString(),\n    version: process.env.APP_VERSION || \"0.0.0\",\n    environment: process.env.NODE_ENV || \"development\",\n    deploymentId: process.env.DEPLOYMENT_ID || \"\",\n  };\n}\n\n// 单例缓存\nlet cachedBuildInfo: BuildInfo | null = null;\n\n/**\n * 获取缓存的构建信息\n */\nexport function getCachedBuildInfo(): BuildInfo {\n  if (!cachedBuildInfo) {\n    cachedBuildInfo = getBuildInfo();\n  }\n  return cachedBuildInfo;\n}\n","/**\n * 追踪上下文模块\n *\n * 使用 AsyncLocalStorage 实现异步上下文隔离\n */\n\nimport { AsyncLocalStorage } from \"node:async_hooks\";\n\nexport interface TraceContext {\n  traceId?: string;\n  requestId?: string;\n  parentSpanId?: string;\n}\n\n// AsyncLocalStorage 实例\nconst asyncLocalStorage = new AsyncLocalStorage<TraceContext>();\n\n/**\n * 获取当前追踪上下文\n */\nexport function getTraceContext(): TraceContext {\n  return asyncLocalStorage.getStore() || {};\n}\n\n/**\n * 获取当前 trace_id\n */\nexport function getTraceId(): string | undefined {\n  return getTraceContext().traceId;\n}\n\n/**\n * 获取当前 request_id\n */\nexport function getRequestId(): string | undefined {\n  return getTraceContext().requestId;\n}\n\n/**\n * 获取当前 parent_span_id\n */\nexport function getParentSpanId(): string | undefined {\n  return getTraceContext().parentSpanId;\n}\n\n/**\n * 在追踪上下文中运行函数\n *\n * @example\n * await runWithTraceContext(\n *   { traceId: 'trace-123', requestId: 'req-456' },\n *   async () => {\n *     // 这里可以访问上下文\n *     const traceId = getTraceId();\n *   }\n * );\n */\nexport function runWithTraceContext<T>(\n  context: TraceContext,\n  fn: () => T\n): T {\n  return asyncLocalStorage.run(context, fn);\n}\n\n/**\n * 从请求 header 解析追踪上下文\n */\nexport function parseTraceContextFromHeaders(headers: Headers): TraceContext {\n  return {\n    traceId: headers.get(\"X-Trace-ID\") || undefined,\n    parentSpanId: headers.get(\"X-Parent-Span-ID\") || undefined,\n    // requestId 每个服务自己生成，不从 header 读取\n  };\n}\n","/**\n * 结构化日志模块\n */\n\nimport { getCachedBuildInfo } from \"../config/build-info\";\nimport { getTraceContext } from \"../tracing/context\";\n\nexport type LogLevel = \"debug\" | \"info\" | \"warn\" | \"error\";\n\nexport interface LogEntry {\n  timestamp: string;\n  level: LogLevel;\n  service: string;\n  version: string;\n  gitCommit: string;\n  environment: string;\n  deploymentId?: string;\n  traceId?: string;\n  requestId?: string;\n  parentSpanId?: string;\n  message: string;\n  extra?: Record<string, unknown>;\n  exception?: {\n    type: string;\n    message: string;\n    stack?: string;\n  };\n}\n\nexport interface LoggerOptions {\n  serviceName: string;\n  format?: \"json\" | \"text\";\n  level?: LogLevel;\n}\n\nconst LOG_LEVELS: Record<LogLevel, number> = {\n  debug: 0,\n  info: 1,\n  warn: 2,\n  error: 3,\n};\n\n/**\n * 创建结构化日志器\n */\nexport function createLogger(options: LoggerOptions) {\n  const {\n    serviceName,\n    format = process.env.LOG_FORMAT === \"text\" ? \"text\" : \"json\",\n    level = (process.env.LOG_LEVEL as LogLevel) || \"info\",\n  } = options;\n\n  const minLevel = LOG_LEVELS[level];\n\n  function shouldLog(logLevel: LogLevel): boolean {\n    return LOG_LEVELS[logLevel] >= minLevel;\n  }\n\n  function formatEntry(entry: LogEntry): string {\n    if (format === \"text\") {\n      const parts = [\n        entry.timestamp,\n        `[${entry.level.toUpperCase()}]`,\n        entry.service,\n        \"-\",\n        entry.message,\n      ];\n\n      if (entry.traceId) {\n        parts.push(`| trace_id=${entry.traceId}`);\n      }\n\n      if (entry.exception) {\n        parts.push(`\\n${entry.exception.stack || entry.exception.message}`);\n      }\n\n      return parts.join(\" \");\n    }\n\n    return JSON.stringify(entry);\n  }\n\n  function log(\n    logLevel: LogLevel,\n    message: string,\n    extra?: Record<string, unknown>,\n    error?: Error\n  ): void {\n    if (!shouldLog(logLevel)) {\n      return;\n    }\n\n    const buildInfo = getCachedBuildInfo();\n    const traceContext = getTraceContext();\n\n    const entry: LogEntry = {\n      timestamp: new Date().toISOString(),\n      level: logLevel,\n      service: serviceName,\n      version: buildInfo.version,\n      gitCommit: buildInfo.shortCommit,\n      environment: buildInfo.environment,\n      message,\n    };\n\n    if (buildInfo.deploymentId) {\n      entry.deploymentId = buildInfo.deploymentId;\n    }\n\n    if (traceContext.traceId) {\n      entry.traceId = traceContext.traceId;\n    }\n\n    if (traceContext.requestId) {\n      entry.requestId = traceContext.requestId;\n    }\n\n    if (traceContext.parentSpanId) {\n      entry.parentSpanId = traceContext.parentSpanId;\n    }\n\n    if (extra && Object.keys(extra).length > 0) {\n      entry.extra = extra;\n    }\n\n    if (error) {\n      entry.exception = {\n        type: error.name,\n        message: error.message,\n        stack: error.stack,\n      };\n    }\n\n    const output = formatEntry(entry);\n\n    switch (logLevel) {\n      case \"debug\":\n        console.debug(output);\n        break;\n      case \"info\":\n        console.info(output);\n        break;\n      case \"warn\":\n        console.warn(output);\n        break;\n      case \"error\":\n        console.error(output);\n        break;\n    }\n  }\n\n  return {\n    debug: (message: string, extra?: Record<string, unknown>) =>\n      log(\"debug\", message, extra),\n\n    info: (message: string, extra?: Record<string, unknown>) =>\n      log(\"info\", message, extra),\n\n    warn: (message: string, extra?: Record<string, unknown>) =>\n      log(\"warn\", message, extra),\n\n    error: (message: string, extra?: Record<string, unknown>, error?: Error) =>\n      log(\"error\", message, extra, error),\n\n    exception: (message: string, error: Error, extra?: Record<string, unknown>) =>\n      log(\"error\", message, extra, error),\n  };\n}\n\n// 默认 logger（需要先配置）\nlet defaultLogger: ReturnType<typeof createLogger> | null = null;\n\n/**\n * 配置默认 logger\n */\nexport function configureLogger(options: LoggerOptions): void {\n  defaultLogger = createLogger(options);\n}\n\n/**\n * 获取默认 logger\n */\nexport function getLogger(): ReturnType<typeof createLogger> {\n  if (!defaultLogger) {\n    // 返回一个空操作的 logger\n    return {\n      debug: () => {},\n      info: () => {},\n      warn: () => {},\n      error: () => {},\n      exception: () => {},\n    };\n  }\n  return defaultLogger;\n}\n"]}
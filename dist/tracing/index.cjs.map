{"version":3,"sources":["../../src/tracing/ids.ts","../../src/tracing/context.ts","../../src/config/build-info.ts","../../src/tracing/middleware.ts"],"names":["AsyncLocalStorage"],"mappings":"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","file":"index.cjs","sourcesContent":["/**\n * 追踪 ID 生成模块\n */\n\n/**\n * 生成随机 hex 字符串\n */\nfunction randomHex(length: number): string {\n  const bytes = new Uint8Array(Math.ceil(length / 2));\n  crypto.getRandomValues(bytes);\n  return Array.from(bytes)\n    .map((b) => b.toString(16).padStart(2, \"0\"))\n    .join(\"\")\n    .substring(0, length);\n}\n\n/**\n * 生成 trace_id\n *\n * 格式: {timestamp_hex}-{random_hex}-{service_short}\n * 示例: 67890abc-f1e2d3c4b5a6-auth\n *\n * @param serviceShort - 服务简称（默认 \"svc\"）\n */\nexport function generateTraceId(serviceShort: string = \"svc\"): string {\n  const timestamp = Math.floor(Date.now() / 1000).toString(16);\n  const random = randomHex(12);\n  return `${timestamp}-${random}-${serviceShort}`;\n}\n\n/**\n * 生成 request_id\n *\n * 格式: {prefix}_{random_hex}\n * 示例: auth_f1e2d3c4b5a6\n *\n * @param prefix - 前缀（默认 \"req\"）\n */\nexport function generateRequestId(prefix: string = \"req\"): string {\n  return `${prefix}_${randomHex(12)}`;\n}\n\n/**\n * 解析 trace_id\n */\nexport function parseTraceId(traceId: string): {\n  valid: boolean;\n  timestamp?: number;\n  random?: string;\n  serviceShort?: string;\n  raw?: string;\n} {\n  const parts = traceId.split(\"-\");\n\n  if (parts.length < 3) {\n    return { valid: false, raw: traceId };\n  }\n\n  const [timestampHex, random, ...serviceParts] = parts;\n  const timestamp = parseInt(timestampHex, 16);\n\n  if (isNaN(timestamp)) {\n    return { valid: false, raw: traceId };\n  }\n\n  return {\n    valid: true,\n    timestamp,\n    random,\n    serviceShort: serviceParts.join(\"-\"),\n  };\n}\n","/**\n * 追踪上下文模块\n *\n * 使用 AsyncLocalStorage 实现异步上下文隔离\n */\n\nimport { AsyncLocalStorage } from \"node:async_hooks\";\n\nexport interface TraceContext {\n  traceId?: string;\n  requestId?: string;\n  parentSpanId?: string;\n}\n\n// AsyncLocalStorage 实例\nconst asyncLocalStorage = new AsyncLocalStorage<TraceContext>();\n\n/**\n * 获取当前追踪上下文\n */\nexport function getTraceContext(): TraceContext {\n  return asyncLocalStorage.getStore() || {};\n}\n\n/**\n * 获取当前 trace_id\n */\nexport function getTraceId(): string | undefined {\n  return getTraceContext().traceId;\n}\n\n/**\n * 获取当前 request_id\n */\nexport function getRequestId(): string | undefined {\n  return getTraceContext().requestId;\n}\n\n/**\n * 获取当前 parent_span_id\n */\nexport function getParentSpanId(): string | undefined {\n  return getTraceContext().parentSpanId;\n}\n\n/**\n * 在追踪上下文中运行函数\n *\n * @example\n * await runWithTraceContext(\n *   { traceId: 'trace-123', requestId: 'req-456' },\n *   async () => {\n *     // 这里可以访问上下文\n *     const traceId = getTraceId();\n *   }\n * );\n */\nexport function runWithTraceContext<T>(\n  context: TraceContext,\n  fn: () => T\n): T {\n  return asyncLocalStorage.run(context, fn);\n}\n\n/**\n * 从请求 header 解析追踪上下文\n */\nexport function parseTraceContextFromHeaders(headers: Headers): TraceContext {\n  return {\n    traceId: headers.get(\"X-Trace-ID\") || undefined,\n    parentSpanId: headers.get(\"X-Parent-Span-ID\") || undefined,\n    // requestId 每个服务自己生成，不从 header 读取\n  };\n}\n","/**\n * 构建信息模块\n *\n * 从环境变量读取 Docker 构建时注入的版本信息\n */\n\nexport interface BuildInfo {\n  /** Git commit hash */\n  gitCommit: string;\n  /** Git commit 短 hash */\n  shortCommit: string;\n  /** Git 分支名 */\n  gitBranch: string;\n  /** 构建日期 */\n  buildDate: string;\n  /** 应用版本 */\n  version: string;\n  /** 运行环境 */\n  environment: string;\n  /** 部署 ID（蓝绿部署） */\n  deploymentId: string;\n}\n\n/**\n * 获取构建信息\n */\nexport function getBuildInfo(): BuildInfo {\n  const gitCommit = process.env.GIT_COMMIT || \"unknown\";\n\n  return {\n    gitCommit,\n    shortCommit: gitCommit.substring(0, 7),\n    gitBranch: process.env.GIT_BRANCH || \"unknown\",\n    buildDate: process.env.BUILD_DATE || new Date().toISOString(),\n    version: process.env.APP_VERSION || \"0.0.0\",\n    environment: process.env.NODE_ENV || \"development\",\n    deploymentId: process.env.DEPLOYMENT_ID || \"\",\n  };\n}\n\n// 单例缓存\nlet cachedBuildInfo: BuildInfo | null = null;\n\n/**\n * 获取缓存的构建信息\n */\nexport function getCachedBuildInfo(): BuildInfo {\n  if (!cachedBuildInfo) {\n    cachedBuildInfo = getBuildInfo();\n  }\n  return cachedBuildInfo;\n}\n","/**\n * Next.js 追踪中间件模块\n */\n\nimport { getCachedBuildInfo } from \"../config/build-info\";\nimport {\n  getTraceContext,\n  parseTraceContextFromHeaders,\n  runWithTraceContext,\n  type TraceContext,\n} from \"./context\";\nimport { generateRequestId, generateTraceId } from \"./ids\";\n\n// Header 常量\nexport const TRACE_ID_HEADER = \"X-Trace-ID\";\nexport const REQUEST_ID_HEADER = \"X-Request-ID\";\nexport const PARENT_SPAN_ID_HEADER = \"X-Parent-Span-ID\";\nexport const DEPLOYMENT_ID_HEADER = \"X-Deployment-ID\";\nexport const RESPONSE_TIME_HEADER = \"X-Response-Time\";\nexport const SERVED_BY_HEADER = \"X-Served-By\";\n\nexport interface TracingOptions {\n  serviceName: string;\n  serviceShort?: string;\n}\n\n/**\n * 为响应添加追踪 header\n */\nexport function addTracingHeaders(\n  response: Response,\n  context: TraceContext,\n  options: {\n    serviceName: string;\n    durationMs: number;\n  }\n): Response {\n  const buildInfo = getCachedBuildInfo();\n\n  // 克隆响应以添加 header\n  const headers = new Headers(response.headers);\n\n  if (context.traceId) {\n    headers.set(TRACE_ID_HEADER, context.traceId);\n  }\n\n  if (context.requestId) {\n    headers.set(REQUEST_ID_HEADER, context.requestId);\n  }\n\n  headers.set(RESPONSE_TIME_HEADER, `${options.durationMs.toFixed(2)}ms`);\n  headers.set(\n    SERVED_BY_HEADER,\n    `${options.serviceName}-${buildInfo.shortCommit}`\n  );\n\n  if (buildInfo.deploymentId) {\n    headers.set(DEPLOYMENT_ID_HEADER, buildInfo.deploymentId);\n  }\n\n  return new Response(response.body, {\n    status: response.status,\n    statusText: response.statusText,\n    headers,\n  });\n}\n\n/**\n * 包装 API route handler 添加追踪支持\n *\n * @example\n * // app/api/users/route.ts\n * import { withTracing } from '@optima/core/tracing';\n *\n * async function handler(request: Request) {\n *   return Response.json({ users: [] });\n * }\n *\n * export const GET = withTracing(handler, {\n *   serviceName: 'agentic-chat',\n *   serviceShort: 'chat',\n * });\n */\nexport function withTracing<T extends (request: Request, ...args: unknown[]) => Promise<Response>>(\n  handler: T,\n  options: TracingOptions\n): T {\n  const { serviceName, serviceShort = serviceName.substring(0, 4) } = options;\n\n  return (async (request: Request, ...args: unknown[]) => {\n    const startTime = Date.now();\n\n    // 从 header 解析上游追踪信息\n    const upstreamContext = parseTraceContextFromHeaders(request.headers);\n\n    // 创建当前请求的上下文\n    const context: TraceContext = {\n      traceId: upstreamContext.traceId || generateTraceId(serviceShort),\n      requestId: generateRequestId(serviceShort),\n      parentSpanId: upstreamContext.parentSpanId,\n    };\n\n    // 在追踪上下文中运行 handler\n    const response = await runWithTraceContext(context, () =>\n      handler(request, ...args)\n    );\n\n    const durationMs = Date.now() - startTime;\n\n    // 添加追踪 header 到响应\n    return addTracingHeaders(response, context, {\n      serviceName,\n      durationMs,\n    });\n  }) as T;\n}\n\n/**\n * 获取需要传递给下游服务的追踪 header\n */\nexport function getTraceHeaders(): Record<string, string> {\n  const context = getTraceContext();\n  const buildInfo = getCachedBuildInfo();\n  const headers: Record<string, string> = {};\n\n  if (context.traceId) {\n    headers[TRACE_ID_HEADER] = context.traceId;\n  }\n\n  if (context.requestId) {\n    headers[PARENT_SPAN_ID_HEADER] = context.requestId;\n  }\n\n  if (buildInfo.deploymentId) {\n    headers[DEPLOYMENT_ID_HEADER] = buildInfo.deploymentId;\n  }\n\n  return headers;\n}\n"]}
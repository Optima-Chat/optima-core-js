{"version":3,"sources":["../../src/config/build-info.ts","../../src/diagnostics/health.ts","../../src/diagnostics/endpoints.ts"],"names":["startTime"],"mappings":"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","file":"index.js","sourcesContent":["/**\n * 构建信息模块\n *\n * 从环境变量读取 Docker 构建时注入的版本信息\n */\n\nexport interface BuildInfo {\n  /** Git commit hash */\n  gitCommit: string;\n  /** Git commit 短 hash */\n  shortCommit: string;\n  /** Git 分支名 */\n  gitBranch: string;\n  /** 构建日期 */\n  buildDate: string;\n  /** 应用版本 */\n  version: string;\n  /** 运行环境 */\n  environment: string;\n  /** 部署 ID（蓝绿部署） */\n  deploymentId: string;\n}\n\n/**\n * 获取构建信息\n */\nexport function getBuildInfo(): BuildInfo {\n  const gitCommit = process.env.GIT_COMMIT || \"unknown\";\n\n  return {\n    gitCommit,\n    shortCommit: gitCommit.substring(0, 7),\n    gitBranch: process.env.GIT_BRANCH || \"unknown\",\n    buildDate: process.env.BUILD_DATE || new Date().toISOString(),\n    version: process.env.APP_VERSION || \"0.0.0\",\n    environment: process.env.NODE_ENV || \"development\",\n    deploymentId: process.env.DEPLOYMENT_ID || \"\",\n  };\n}\n\n// 单例缓存\nlet cachedBuildInfo: BuildInfo | null = null;\n\n/**\n * 获取缓存的构建信息\n */\nexport function getCachedBuildInfo(): BuildInfo {\n  if (!cachedBuildInfo) {\n    cachedBuildInfo = getBuildInfo();\n  }\n  return cachedBuildInfo;\n}\n","/**\n * 健康检查模块\n */\n\nimport { getCachedBuildInfo } from \"../config/build-info\";\n\nexport interface HealthCheckResult {\n  status: \"healthy\" | \"unhealthy\";\n  latencyMs?: number;\n  error?: string;\n}\n\nexport type HealthCheckFn = () => Promise<HealthCheckResult> | HealthCheckResult;\n\nexport interface HealthChecks {\n  [name: string]: HealthCheckFn;\n}\n\nexport interface HealthResponse {\n  status: \"healthy\" | \"unhealthy\";\n  service: string;\n  version: string;\n  gitCommit: string;\n  gitBranch: string;\n  environment: string;\n  uptimeSeconds: number;\n  timestamp: string;\n  checks: Record<string, HealthCheckResult>;\n}\n\n// 启动时间\nconst startTime = Date.now();\n\n/**\n * 运行健康检查\n */\nexport async function runHealthChecks(\n  serviceName: string,\n  checks: HealthChecks = {}\n): Promise<HealthResponse> {\n  const buildInfo = getCachedBuildInfo();\n  const checkResults: Record<string, HealthCheckResult> = {};\n  let overallHealthy = true;\n\n  // 运行所有检查\n  for (const [name, checkFn] of Object.entries(checks)) {\n    const start = Date.now();\n    try {\n      const result = await checkFn();\n      checkResults[name] = {\n        ...result,\n        latencyMs: Date.now() - start,\n      };\n      if (result.status === \"unhealthy\") {\n        overallHealthy = false;\n      }\n    } catch (error) {\n      overallHealthy = false;\n      checkResults[name] = {\n        status: \"unhealthy\",\n        latencyMs: Date.now() - start,\n        error: error instanceof Error ? error.message : String(error),\n      };\n    }\n  }\n\n  return {\n    status: overallHealthy ? \"healthy\" : \"unhealthy\",\n    service: serviceName,\n    version: buildInfo.version,\n    gitCommit: buildInfo.shortCommit,\n    gitBranch: buildInfo.gitBranch,\n    environment: buildInfo.environment,\n    uptimeSeconds: Math.floor((Date.now() - startTime) / 1000),\n    timestamp: new Date().toISOString(),\n    checks: checkResults,\n  };\n}\n\n/**\n * 创建 Next.js API Route 健康检查处理器\n *\n * @example\n * // app/api/health/route.ts\n * import { createHealthHandler } from '@optima/core/diagnostics';\n *\n * export const GET = createHealthHandler({\n *   serviceName: 'agentic-chat',\n *   checks: {\n *     database: async () => {\n *       // 检查数据库\n *       return { status: 'healthy' };\n *     },\n *   },\n * });\n */\nexport function createHealthHandler(options: {\n  serviceName: string;\n  checks?: HealthChecks;\n}): () => Promise<Response> {\n  return async function GET(): Promise<Response> {\n    const result = await runHealthChecks(\n      options.serviceName,\n      options.checks || {}\n    );\n\n    return Response.json(result, {\n      status: result.status === \"healthy\" ? 200 : 503,\n      headers: {\n        \"Cache-Control\": \"no-store\",\n      },\n    });\n  };\n}\n","/**\n * 调试端点模块\n */\n\nimport { getCachedBuildInfo } from \"../config/build-info\";\n\n// 启动时间\nconst startTime = Date.now();\n\nexport interface DebugInfoResponse {\n  build: {\n    gitCommit: string;\n    gitBranch: string;\n    buildDate: string;\n    version: string;\n  };\n  runtime: {\n    nodeVersion: string;\n    environment: string;\n    debugMode: boolean;\n    logLevel: string;\n  };\n  startupTime: string;\n  uptimeSeconds: number;\n}\n\nexport interface DebugConfigResponse {\n  config: Record<string, string>;\n  /** 构建时内联的环境变量（如 Next.js 的 NEXT_PUBLIC_*） */\n  buildTimeConfig?: Record<string, string>;\n  infisicalEnabled: boolean;\n  configSource: string;\n  environment: string;\n}\n\n/**\n * 获取调试信息\n */\nexport function getDebugInfo(): DebugInfoResponse {\n  const buildInfo = getCachedBuildInfo();\n\n  return {\n    build: {\n      gitCommit: buildInfo.gitCommit,\n      gitBranch: buildInfo.gitBranch,\n      buildDate: buildInfo.buildDate,\n      version: buildInfo.version,\n    },\n    runtime: {\n      nodeVersion: process.version,\n      environment: buildInfo.environment,\n      debugMode: process.env.DEBUG === \"true\",\n      logLevel: process.env.LOG_LEVEL || \"info\",\n    },\n    startupTime: new Date(startTime).toISOString(),\n    uptimeSeconds: Math.floor((Date.now() - startTime) / 1000),\n  };\n}\n\n/**\n * 敏感环境变量模式\n */\nconst SENSITIVE_PATTERNS = [\n  /key/i,\n  /secret/i,\n  /password/i,\n  /token/i,\n  /credential/i,\n  /private/i,\n  /auth/i,\n];\n\n/**\n * 脱敏环境变量值\n */\nfunction maskValue(key: string, value: string): string {\n  const isSensitive = SENSITIVE_PATTERNS.some((pattern) => pattern.test(key));\n\n  if (isSensitive) {\n    return `** (${value.length} chars)`;\n  }\n\n  // URL 中的密码脱敏\n  if (value.includes(\"://\") && value.includes(\"@\")) {\n    return value.replace(/:([^@/]+)@/, \":***@\");\n  }\n\n  return value;\n}\n\n/**\n * 获取脱敏后的配置\n */\nexport function getDebugConfig(\n  allowedPrefixes: string[] = [\"DATABASE\", \"REDIS\", \"OAUTH\", \"CORS\", \"API\"],\n  buildTimeEnv?: Record<string, string | undefined>\n): DebugConfigResponse {\n  const config: Record<string, string> = {};\n\n  for (const [key, value] of Object.entries(process.env)) {\n    if (!value) continue;\n\n    // 只返回指定前缀的变量\n    const matchesPrefix = allowedPrefixes.some((prefix) =>\n      key.startsWith(prefix)\n    );\n\n    if (matchesPrefix) {\n      config[key] = maskValue(key, value);\n    }\n  }\n\n  // 处理构建时内联的环境变量\n  let buildTimeConfig: Record<string, string> | undefined;\n  if (buildTimeEnv) {\n    buildTimeConfig = {};\n    for (const [key, value] of Object.entries(buildTimeEnv)) {\n      if (value) {\n        buildTimeConfig[key] = maskValue(key, value);\n      }\n    }\n  }\n\n  return {\n    config,\n    buildTimeConfig,\n    infisicalEnabled: !!process.env.INFISICAL_CLIENT_ID,\n    configSource: process.env.INFISICAL_CLIENT_ID ? \"infisical\" : \"env\",\n    environment: process.env.NODE_ENV || \"development\",\n  };\n}\n\n/**\n * 验证 Debug Key\n */\nexport function validateDebugKey(request: Request): boolean {\n  const debugKey = process.env.DEBUG_KEY;\n  if (!debugKey) {\n    return false;\n  }\n\n  const providedKey = request.headers.get(\"X-Debug-Key\");\n  return providedKey === debugKey;\n}\n\n/**\n * 创建 /debug/info 端点处理器\n *\n * @example\n * // app/api/debug/info/route.ts\n * import { createDebugInfoHandler } from '@optima/core/diagnostics';\n * export const GET = createDebugInfoHandler();\n */\nexport function createDebugInfoHandler(options?: { requireKey?: boolean }): (\n  request: Request\n) => Promise<Response> {\n  return async function GET(request: Request): Promise<Response> {\n    if (options?.requireKey && !validateDebugKey(request)) {\n      return Response.json({ error: \"Unauthorized\" }, { status: 401 });\n    }\n\n    return Response.json(getDebugInfo(), {\n      headers: { \"Cache-Control\": \"no-store\" },\n    });\n  };\n}\n\n/**\n * 创建 /debug/config 端点处理器\n *\n * @example\n * // app/api/debug/config/route.ts (Node.js 服务)\n * import { createDebugConfigHandler } from '@optima/core/diagnostics';\n * export const GET = createDebugConfigHandler();\n *\n * @example\n * // app/api/debug/config/route.ts (Next.js 服务，需要展示构建时内联的 NEXT_PUBLIC_* 变量)\n * import { createDebugConfigHandler } from '@optima/core/diagnostics';\n * export const GET = createDebugConfigHandler({\n *   allowedPrefixes: ['DATABASE', 'MCP', 'NEXT_PUBLIC'],\n *   // 构建时内联的值（webpack 会在构建时替换 process.env.NEXT_PUBLIC_*）\n *   buildTimeEnv: {\n *     NEXT_PUBLIC_SHOP_DOMAIN: process.env.NEXT_PUBLIC_SHOP_DOMAIN,\n *     NEXT_PUBLIC_BASE_URL: process.env.NEXT_PUBLIC_BASE_URL,\n *   }\n * });\n */\nexport function createDebugConfigHandler(options?: {\n  allowedPrefixes?: string[];\n  /** 构建时内联的环境变量，用于 Next.js 等在构建时替换 process.env 的框架 */\n  buildTimeEnv?: Record<string, string | undefined>;\n}): (request: Request) => Promise<Response> {\n  return async function GET(request: Request): Promise<Response> {\n    if (!validateDebugKey(request)) {\n      return Response.json(\n        { error: \"Unauthorized - X-Debug-Key required\" },\n        { status: 401 }\n      );\n    }\n\n    return Response.json(\n      getDebugConfig(options?.allowedPrefixes, options?.buildTimeEnv),\n      {\n        headers: { \"Cache-Control\": \"no-store\" },\n      }\n    );\n  };\n}\n"]}